#include <Arduino.h>

// Comunicación serial
const long BAUD_RATE = 19200;

// Variables ángulos
float anguloPelota = 0.0;
float anguloArco_Amarillo = 0.0; 
float anguloArco_Azul = 0.0;

// Posiciones codificadas
int codedYp = 0, codedYam = 0, codedYaz = 0;
int codedXp = 0, codedXam = 0, codedXaz = 0;

// Posiciones decodificadas
float Xp = 0.0, Yp = 0.0;
float Xam = 0.0, Yam = 0.0;
float Xaz = 0.0, Yaz = 0.0;

// Headers 
int header1 = 0; 
int header2 = 0; 
int header3 = 0; 

// Presencia de objetos
bool haypelota = false;
bool hayarco_amarillo = false;
bool hayarco_azul = false;

// ---- SETUP ----
void setup() 
{
  Serial.begin(BAUD_RATE);
  Serial1.begin(BAUD_RATE);

  Serial.println("Decodificador iniciado");
}

// ---- LOOP ----
void loop() {
  // Lectura de datos serial
  if (Serial1.available() >= 9)
  {
    header1 = Serial1.read();
    codedXp = Serial1.read();
    codedYp = Serial1.read();
    header2 = Serial1.read(); 
    codedXam = Serial1.read();
    codedYam = Serial1.read();
    header3 = Serial1.read(); 
    codedXaz = Serial1.read();
    codedYaz = Serial1.read(); 

    if (header1 == 201 && header2 == 202 && header3 == 203)
    {
      Xp = codedXp; 
      Yp = codedYp - 100; 
      Xam = codedXam; 
      Yam = codedYam - 100; 
      Xaz = codedXaz; 
      Yaz = codedYaz - 100; 

      // Calcular el ángulos
        anguloPelota = atan2(Yp, Xp) * 180.0 / PI;
        anguloArco_Amarillo = atan2(Yam, Xam) * 180.0 / PI;
        anguloArco_Azul = atan2(Yaz, Xaz) * 180.0 / PI;

//      // Mostrar datos
//      Serial.print("X pelota: "); Serial.print(Xp);
//      Serial.print(" | Y pelota: "); Serial.print(Yp);
//      Serial.print(" | X arco amarillo: "); Serial.print(Xam);
//      Serial.print(" | Y arco amarillo: "); Serial.print(Yam);
//      Serial.print(" | X arco azul: "); Serial.print(Xaz);
//      Serial.print(" | Y arco azul: "); Serial.println(Yaz);


      if ( Xp == 0 )
      { haypelota = false; }
      else
      { haypelota = true; }

      if ( Xam == 0 )
      { hayarco_amarillo = false; }
      else
      { hayarco_amarillo = true; } 

      if ( Xaz == 0 )
      { hayarco_azul = false; }
      else
      { hayarco_azul = true; }

      Serial.print("pelota: "); Serial.print(haypelota); 
      Serial.print("| arco amarillo: "); Serial.print(hayarco_amarillo);
      Serial.print("| arco azul: "); Serial.println(hayarco_azul);
    } 
  }    
}
